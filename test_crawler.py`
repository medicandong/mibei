#!/usr/bin/env python3
"""
æµ‹è¯•çˆ¬è™«åŠŸèƒ½çš„ç®€å•è„šæœ¬
ç”¨äºéªŒè¯çˆ¬è™«æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
"""

import sys
import os

# æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from enhanced_crawler import EnhancedNodeCrawler
    print("âœ… æˆåŠŸå¯¼å…¥EnhancedNodeCrawler")
except ImportError as e:
    print(f"âŒ å¯¼å…¥å¤±è´¥: {e}")
    sys.exit(1)

def test_crawler():
    """æµ‹è¯•çˆ¬è™«åŠŸèƒ½"""
    print("ğŸ§ª å¼€å§‹æµ‹è¯•çˆ¬è™«åŠŸèƒ½...")
    
    crawler = EnhancedNodeCrawler()
    
    # æµ‹è¯•è·å–æœ€æ–°æ–‡ç« é“¾æ¥
    print("\n1. æµ‹è¯•è·å–æœ€æ–°æ–‡ç« é“¾æ¥...")
    article_url = crawler.get_latest_article_url()
    
    if article_url:
        print(f"âœ… æˆåŠŸè·å–æ–‡ç« é“¾æ¥: {article_url}")
        
        # æµ‹è¯•æå–è®¢é˜…é“¾æ¥
        print("\n2. æµ‹è¯•æå–è®¢é˜…é“¾æ¥...")
        subscription_url = crawler.extract_subscription_link(article_url)
        
        if subscription_url:
            print(f"âœ… æˆåŠŸæå–è®¢é˜…é“¾æ¥: {subscription_url}")
            
            # æµ‹è¯•ä¸‹è½½è®¢é˜…å†…å®¹
            print("\n3. æµ‹è¯•ä¸‹è½½è®¢é˜…å†…å®¹...")
            content = crawler.download_subscription_content(subscription_url)
            
            if content:
                print(f"âœ… æˆåŠŸä¸‹è½½è®¢é˜…å†…å®¹ï¼Œé•¿åº¦: {len(content)} å­—ç¬¦")
                print(f"ğŸ“ å†…å®¹é¢„è§ˆï¼ˆå‰200å­—ç¬¦ï¼‰: {content[:200]}...")
                
                # ä¿å­˜æµ‹è¯•æ–‡ä»¶
                with open('test_subscription.txt', 'w', encoding='utf-8') as f:
                    f.write(content)
                print("âœ… æµ‹è¯•å†…å®¹å·²ä¿å­˜åˆ° test_subscription.txt")
                
                return True
            else:
                print("âŒ ä¸‹è½½è®¢é˜…å†…å®¹å¤±è´¥")
        else:
            print("âŒ æå–è®¢é˜…é“¾æ¥å¤±è´¥")
    else:
        print("âŒ è·å–æœ€æ–°æ–‡ç« é“¾æ¥å¤±è´¥")
    
    return False

if __name__ == "__main__":
    print("ğŸš€ èŠ‚ç‚¹è®¢é˜…çˆ¬è™«æµ‹è¯•å·¥å…·")
    print("=" * 50)
    
    success = test_crawler()
    
    print("\n" + "=" * 50)
    if success:
        print("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼çˆ¬è™«åŠŸèƒ½æ­£å¸¸")
        print("ğŸ’¡ æç¤ºï¼šç°åœ¨å¯ä»¥éƒ¨ç½²åˆ°GitHub Actionsäº†")
    else:
        print("âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š")
        print("   - ç½‘ç»œè¿æ¥")
        print("   - ç›®æ ‡ç½‘ç«™å¯è®¿é—®æ€§")
        print("   - ç½‘ç«™ç»“æ„æ˜¯å¦å˜åŒ–")
        print("   - å¯èƒ½éœ€è¦æ›´æ–°çˆ¬è™«è„šæœ¬")
    
    sys.exit(0 if success else 1)
